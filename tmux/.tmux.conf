##### Basics #####

# Start counting from 1
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on    # Renumber windows after close



# Clipboard & history
set-option -g set-clipboard on
set-option -g @fastcopy-action 'tmux load-buffer -w -'
set-option -g history-limit 100000   # Scrollback size (lines)

# Mouse (selection/scroll/resize). Hold Shift to use terminal's native selection.
set -g mouse on

# Use vi keys in copy mode
set-window-option -g mode-keys vi
bind-key -T copy-mode-vi v send -X begin-selection
bind-key -T copy-mode-vi V send -X select-line
bind-key -T copy-mode-vi y send -X copy-pipe-and-cancel "$HOME/GithubRepos/dotfiles/tmux/copy-to-clipboard.sh"
bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel "$HOME/GithubRepos/dotfiles/tmux/copy-to-clipboard.sh"
bind-key -T copy-mode Enter send -X copy-pipe-and-cancel "$HOME/GithubRepos/dotfiles/tmux/copy-to-clipboard.sh"

# Toggle mouse quickly: <prefix> + m
bind-key m set -g mouse \; display-message "mouse: #{?mouse,on,off}"

# Reload tmux config: <prefix> + r
bind-key r source-file ~/.tmux.conf \; display-message "Reloaded ~/.tmux.conf"

# Refresh client: <prefix> + R
bind-key R refresh-client

# tmux-yank: make copy-mode yank always use our cross-platform clipboard helper
if-shell '[ -x "$HOME/GithubRepos/dotfiles/tmux/copy-to-clipboard.sh" ]' \
  'set -g @override_copy_command "$HOME/GithubRepos/dotfiles/tmux/copy-to-clipboard.sh"' \
  'set -gu @override_copy_command'

# Terminal: 256 colors + TrueColor
set -g default-terminal "tmux-256color"
set -g terminal-overrides ",*:RGB"


##### Plugins (TPM) #####

set -g @plugin 'tmux-plugins/tpm'

# CPU / weather / battery / focus
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'xamut/tmux-weather'
set -g @plugin 'tmux-plugins/tmux-battery'
set -g @plugin 'olimorris/tmux-pomodoro-plus'

# Copy enhancements
# fastcopy: <prefix> + f
set -g @plugin 'abhinav/tmux-fastcopy'
# yank: <prefix> + y
set -g @plugin 'tmux-plugins/tmux-yank'

# Session persistence
# <prefix> + Ctrl-s to save, <prefix> + Ctrl-r to restore
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# fzf integration
set -g @plugin 'sainnhe/tmux-fzf'

# treemux (project tree via nvim)
set -g @treemux-tree-nvim-init-file '~/.tmux/plugins/treemux/configs/treemux_init.lua'
set -g @plugin 'kiyoon/treemux'

# Status bar theme (with prefix indicator)
set -g @plugin 'niksingh710/minimal-tmux-status'

# Jump between windows
# <prefix> + j fuzzy-jump by window name
set -g @plugin 'schasse/tmux-jump'


##### tmux-fzf config #####

# Switch windows via fzf: <prefix> + g
bind-key "g" run-shell -b "~/.tmux/plugins/tmux-fzf/scripts/window.sh switch"

# Window display format / behavior (read by the plugin)
TMUX_FZF_WINDOW_FORMAT="[#{window_name}] #{window_index} #{b:pane_current_path} #{pane_current_command} [#{pane_width}x#{pane_height}] [history #{history_size}/#{history_limit}, #{history_bytes} bytes] #{?pane_active,[active],[inactive]}"
TMUX_FZF_OPTIONS="-p -w 50% -h 60% -m"
TMUX_FZF_PREVIEW=0

# Workspace search script: <prefix> + s
bind-key "s" run-shell -b "~/GithubRepos/dotfiles/tmux/workspace-search.sh"

##### spymux #####

# <prefix> + v preview all panes (tmux >= 3.2 uses popup)
if -F '#{>=:#{version},3.2}' \
  'bind-key "v" display-popup -E -w 90% -h 80% -d "#{pane_current_path}" "spymux"' \
  'bind-key "v" new-window -n "spymux" "spymux"'

# <prefix> + V preview codex panes only
# Note: macOS/Linux 上 #{pane_current_command} 可能会被截断到 15 个字符（例如 codex-aarch64-a）
if -F '#{>=:#{version},3.2}' \
  'bind-key "V" display-popup -E -w 90% -h 80% -d "#{pane_current_path}" "spymux -c codex,codex-aarch64-a,codex-x86_64-ap,codex-aarch64-u,codex-x86_64-un"' \
  'bind-key "V" new-window -n "spymux-codex" "spymux -c codex,codex-aarch64-a,codex-x86_64-ap,codex-aarch64-u,codex-x86_64-un"'


##### IPython Popup #####

# <prefix> + i quick IPython (tmux >= 3.2 uses popup)
if -F '#{>=:#{version},3.2}' \
  'bind-key "i" display-popup -E -T "IPython" -w 90% -h 80% -d "#{pane_current_path}" "ipython"' \
  'bind-key "i" new-window -n "ipython" -c "#{pane_current_path}" "ipython"'


##### Popup tools #####

# <prefix> + G lazygit popup (tmux >= 3.2 uses popup)
if -F '#{>=:#{version},3.2}' \
  'bind-key "G" if-shell "command -v lazygit >/dev/null 2>&1" "display-popup -E -T \"lazygit\" -w 90% -h 80% -d \"#{pane_current_path}\" \"env LANG=en_US.UTF-8 lazygit\"" "display-message \"lazygit is not installed\""' \
  'bind-key "G" if-shell "command -v lazygit >/dev/null 2>&1" "new-window -n \"lazygit\" -c \"#{pane_current_path}\" \"env LANG=en_US.UTF-8 lazygit\"" "display-message \"lazygit is not installed\""' 

# <prefix> + B btop popup (tmux >= 3.2 uses popup)
if -F '#{>=:#{version},3.2}' \
  'bind-key "B" if-shell "command -v btop >/dev/null 2>&1" "display-popup -E -T \"btop\" -w 90% -h 80% -d \"#{pane_current_path}\" \"btop\"" "display-message \"btop is not installed\""' \
  'bind-key "B" if-shell "command -v btop >/dev/null 2>&1" "new-window -n \"btop\" -c \"#{pane_current_path}\" \"btop\"" "display-message \"btop is not installed\""' 

# <prefix> + Space temp shell (overrides default next-layout; tmux >= 3.2 uses popup)
if -F '#{>=:#{version},3.2}' \
  'bind-key "Space" display-popup -E -T "Shell" -w 90% -h 80% -d "#{pane_current_path}"' \
  'bind-key "Space" new-window -n "shell" -c "#{pane_current_path}"'


##### treemux #####

# treemux plugin and init file are configured above; nothing else needed here


##### GitHub Light theme #####
# A lightweight palette close to GitHub “Light” (Primer):
#   Background:        #FFFFFF
#   Subtle background: #F6F8FA
#   Border:            #D0D7DE
#   Text:              #24292F
#   Muted text:        #57606A
#   Accent (blue):     #0969DA

###### minimal-tmux-status colors ######

# NOTE: minimal-tmux-status 用 @minimal-tmux-bg/@minimal-tmux-fg 来渲染「当前窗口」的选中块
# 之前用 #F6F8FA 在浅色终端里对比太弱，这里改成 GitHub 蓝底白字，当前窗口更清晰。
set -g @minimal-tmux-fg "#FFFFFF"        # Selected text
set -g @minimal-tmux-bg "#0969DA"        # Selected background (accent blue)

set -g @minimal-tmux-justify "centre"
set -g @minimal-tmux-indicator true
set -g @minimal-tmux-status "bottom"

# Minimal inactive windows: list shows only index (current window name moved to left)
set -g @minimal-tmux-window-status-format " #I#{?window_last_flag,•,} "

# Center prefix/tmux indicator
set -g @minimal-tmux-indicator-str ""

# Enable left and right status
set -g @minimal-tmux-right true
set -g @minimal-tmux-left true

# Fullscreen icon
set -g @minimal-tmux-expanded-icon "󰊓 "

# Nerd Font rounded arrows
set -g @minimal-tmux-use-arrow true
set -g @minimal-tmux-right-arrow ""
set -g @minimal-tmux-left-arrow ""

# Left extra info: current window name (truncated)
# Color matches the hostname on the right (accent blue / #0969DA)
set -g @minimal-tmux-status-left-extra " #[none,fg=#8C959F]│#[fg=#0969DA,bold] #{=/24/...:window_name}#{?window_zoomed_flag, 󰊓 ,}"
set -g @minimal-tmux-status-right-extra ""

# Right: hostname + time (accent blue + subtle separator)
set -g @minimal-tmux-status-right "#[fg=#0969DA,bold]#(hostname -s) #[fg=#8C959F]"

# When the theme is toggled off, keep tmux status styles consistent
set -g status-position bottom
set -g status on
set -g status-style "fg=#24292F,bg=#F6F8FA"

# Window list (effective when minimal-tmux-status is disabled)
set -g window-status-style "fg=#57606A,bg=#F6F8FA"                 # muted text on subtle bg
set -g window-status-current-style "fg=#24292F,bg=#FFFFFF,bold"    # active window on white
set -g window-status-activity-style "fg=#0969DA,bg=#F6F8FA"        # activity highlighted in blue
set -g window-status-separator ""                                  # Remove default separator

# Message / command-line / copy-mode colors
set -g message-style "fg=#FFFFFF,bg=#0969DA"                       # blue bg for messages
set -g message-command-style "fg=#24292F,bg=#EAEEF2"               # subtle gray while entering commands
setw -g mode-style "bg=#0969DA,fg=#FFFFFF"                         # copy-mode selection highlight
setw -g copy-mode-selection-style "bg=#FFD54F,fg=#24292F,bold"      # make selection obvious
set -g clock-mode-colour "#0969DA"                                 # Large clock color (<prefix> + t)

set -g status-left-length 150
set -g status-right-length 150

##### Pane borders & pane numbers (GitHub Light) #####

# Show pane number on top
set -g pane-border-status top
# Prefix active pane with ★
# Also show a short (truncated) current path after the pane number
set -g pane-border-format '#{?pane_active, ★ #P ,  #P }#[fg=#8C959F]│ #{?pane_active,#[fg=#0969DA]#[bold],#[fg=#57606A]}#{=/-35/...:#{s|#{HOME}|~|:pane_current_path}}  #[default]'

# Inactive pane border: subtle border
set -g pane-border-style 'fg=#D0D7DE'

# Active pane border: accent blue + bold
set -g pane-active-border-style 'fg=#0969DA,bold'

# If tmux >= 3.2, use heavy border lines
if -F '#{>=:#{version},3.2}' 'set -g pane-border-lines heavy'

# Colors for pane numbers shown via <prefix> + q
set -g display-panes-colour "#57606A"          # muted text
set -g display-panes-active-colour "#0969DA"   # accent blue

# show-panes duration (ms)
set -g display-panes-time 10000


##### Auto rename windows / terminal title #####

# Auto-rename windows (icon + directory)
set -g automatic-rename on
set -g automatic-rename-format '#(~/GithubRepos/dotfiles/tmux/window-title.sh "#{pane_current_command}" "#{pane_current_path}")'

# After manual rename, lock window name (prevent auto/OSC reset)
set-hook -g after-rename-window 'set -w automatic-rename off; set -w allow-rename off'

# Auto-set terminal title
set -g set-titles on
set -g set-titles-string 'Tmux[#{session_name} #{session_windows} #{host} #{pane_current_path}]'


##### Other behavior & key bindings #####

# History limit (already set above)
# set-option -g history-limit 100000

# Keep current directory when splitting panes
bind '"' split-window -v -c "#{pane_current_path}"
bind '%' split-window -h -c "#{pane_current_path}"

# Fast window reordering (Vim-style): <prefix> + H/L move left/right, <prefix> + K choose target index
bind -r H swap-window -t -1
bind -r L swap-window -t +1
bind K command-prompt -p "Move current window to index" "move-window -r -t '%%'"

# tmux-jump: <prefix> + j search and jump by window name (plugin declared above)


##### Default shell (by OS) #####

if-shell "[ $(uname) = 'Linux' ]" \
    'set-option -g default-shell /usr/bin/zsh' \
    'set-option -g default-shell /bin/zsh'


##### Custom window list format (lazy load) #####

# Remove this hook if you don't need to reload window format on client attach
# set-hook -g client-attached "run-shell 'tmux source-file ~/GithubRepos/dotfiles/tmux/window-format.conf'"


##### TPM init (must be at end) #####

run '~/.tmux/plugins/tpm/tpm'
