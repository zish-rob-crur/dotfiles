##### 基础行为 #####

# 从 1 开始计数
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on    # 关闭窗口后自动重排编号



# 剪贴板 & 历史
set-option -g set-clipboard on
set-option -g @fastcopy-action 'tmux load-buffer -w -'
set-option -g history-limit 100000   # 缓存区大小（行数）

# 复制模式使用 vi 键位
set-window-option -g mode-keys vi
bind-key -T copy-mode-vi v send -X begin-selection
bind-key -T copy-mode-vi V send -X select-line
bind-key -T copy-mode-vi y send -X copy-pipe-and-cancel 'xclip -in -selection clipboard'

# 终端能力：256 色 + TrueColor
set -g default-terminal "tmux-256color"
set -g terminal-overrides ",*:RGB"


##### 插件（TPM） #####

set -g @plugin 'tmux-plugins/tpm'

# CPU / 天气 / 电池 / 专注
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'xamut/tmux-weather'
set -g @plugin 'tmux-plugins/tmux-battery'
set -g @plugin 'olimorris/tmux-pomodoro-plus'

# 拷贝增强
# fastcopy: <prefix> + f
set -g @plugin 'abhinav/tmux-fastcopy'
# yank: <prefix> + y
set -g @plugin 'tmux-plugins/tmux-yank'

# 会话持久化
# prefix + Ctrl-s 保存, prefix + Ctrl-r 恢复
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# fzf 集成
set -g @plugin 'sainnhe/tmux-fzf'

# treemux（基于 nvim 的“项目树”）
set -g @treemux-tree-nvim-init-file '~/.tmux/plugins/treemux/configs/treemux_init.lua'
set -g @plugin 'kiyoon/treemux'

# 状态栏主题（带 prefix 指示）
set -g @plugin 'niksingh710/minimal-tmux-status'

# 跳转窗口
# <prefix> + j 通过窗口名模糊跳转
set -g @plugin 'schasse/tmux-jump'


##### tmux-fzf 配置 #####

# 使用 fzf 切换窗口：<prefix> + g
bind-key "g" run-shell -b "~/.tmux/plugins/tmux-fzf/scripts/window.sh switch"

# fzf 窗口显示格式 / 行为（插件读取这些环境变量）
TMUX_FZF_WINDOW_FORMAT="[#{window_name}] #{window_index} #{b:pane_current_path} #{pane_current_command} [#{pane_width}x#{pane_height}] [history #{history_size}/#{history_limit}, #{history_bytes} bytes] #{?pane_active,[active],[inactive]}"
TMUX_FZF_OPTIONS="-p -w 50% -h 60% -m"
TMUX_FZF_PREVIEW=0

# 你的 workspace 搜索脚本：<prefix> + s
bind-key "s" run-shell -b "~/GithubRepos/dotfiles/tmux/workspace-search.sh"


##### treemux #####

# 上面已经设置 treemux 插件和 init file，这里无需额外配置


##### Flexoki 主题设置 #####
# 颜色取自官方 Flexoki Dark 调色板:
#   背景:  black      #100F0F   (bg)
#   UI 边框: base-900 #282726   (ui)
#   激活边框: base-800 #403E3C  (ui-3)
#   主文本: base-200  #CECDC3   (tx)
#   强调:   cyan-400  #3AA99F   (cy-2，用于 active/link)
#   高亮:   yellow-400 #D0A215  (ye-2) :contentReference[oaicite:0]{index=0}

###### minimal-tmux-status 配色 ######

# 主状态栏前景/背景，和 iTerm2 Flexoki Dark 保持一致
set -g @minimal-tmux-fg "#CECDC3"        # 主文字 base-200 (tx)
set -g @minimal-tmux-bg "#100F0F"        # 主背景 black (bg)

set -g @minimal-tmux-justify "centre"
set -g @minimal-tmux-indicator true
set -g @minimal-tmux-status "bottom"

# 中间的 prefix / tmux 标识
set -g @minimal-tmux-indicator-str "   tmux  "

# 启用左右状态栏
set -g @minimal-tmux-right true
set -g @minimal-tmux-left true

# 最大化图标（fullscreen）
set -g @minimal-tmux-expanded-icon "󰊓 "

# 使用 Nerd Font 的圆角箭头
set -g @minimal-tmux-use-arrow true
set -g @minimal-tmux-right-arrow ""
set -g @minimal-tmux-left-arrow ""

# 额外左右文本（保持简洁）
set -g @minimal-tmux-status-left-extra ""
set -g @minimal-tmux-status-right-extra ""

# 右侧：主机名 + 时间（Flexoki 强调色）
# cy-400 (#3AA99F) 用作“active”色，base-700 (#575653) 做分隔符
set -g @minimal-tmux-status-right " #[fg=#3AA99F,bold]#(hostname) #[fg=#575653]"

# 当主题被 toggle 掉时，tmux 自身的 status 样式也尽量保持一致
set -g status-position bottom
set -g status-style "fg=#CECDC3,bg=#100F0F"

# 窗口列表（在 minimal-tmux-status 关闭时生效）
set -g window-status-style "fg=#878580,bg=default"                 # base-500 略微灰一点
set -g window-status-current-style "fg=#FFFCF0,bg=#343331,bold"    # paper on base-850
set -g window-status-activity-style "fg=#3AA99F,bg=default"        # 活动窗口用 cyan 高亮
set -g window-status-separator ""                                  # 去掉默认分隔符

# 消息 / 命令行 / copy-mode 等提示色
set -g message-style "fg=#100F0F,bg=#D0A215"                       # yellow-400 背景，用于普通消息
set -g message-command-style "fg=#FFFCF0,bg=#3AA99F"               # 输入命令时略微区分
setw -g mode-style "bg=#3AA99F,fg=#100F0F"                         # copy-mode 选中高亮 (Cyan背景+黑字)
set -g clock-mode-colour "#D0A215"                                 # prefix + t 的大钟颜色 (yellow-400)


##### Pane 边框 & 显示编号（Flexoki 风格） #####

# 在 pane 顶部显示 pane 编号
set -g pane-border-status top
# 激活 pane 前面加一个 ★
set -g pane-border-format '#{?pane_active, ★ #P ,  #P }'

# 非激活 pane 边框：偏暗的 UI 边框
set -g pane-border-style 'fg=#343331'          # base-850

# 激活 pane 边框：使用 cyan 强调 + 粗体
set -g pane-active-border-style 'fg=#3AA99F,bold'   # cyan-400

# 如果 tmux >= 3.2，用更粗的 border 线
if -F '#{>=:#{version},3.2}' 'set -g pane-border-lines heavy'

# prefix + q 显示 pane 编号时的配色
set -g display-panes-colour "#575653"          # base-700
set -g display-panes-active-colour "#3AA99F"   # cyan-400

# show-panes 持续时间（毫秒）
set -g display-panes-time 10000


##### 自动重命名窗口 / 终端标题 #####

# 自动重命名窗口（图标 + 目录）
set -g automatic-rename on
set -g automatic-rename-format '[#(~/GithubRepos/dotfiles/tmux/window-title.sh "#{pane_current_command}" "#{pane_current_path}")]'

# 手动 rename 后锁定窗口名（防止被自动/OSC 重置）
set-hook -g after-rename-window 'set -w -t #{window_id} automatic-rename off; set -w -t #{window_id} allow-rename off'

# 自动设置终端 title
set -g set-titles on
set -g set-titles-string 'Tmux[#{session_name} #{session_windows} #{host} #{pane_current_path}]'


##### 其他行为 & 按键绑定 #####

# 历史条数（已在上面设置）
# set-option -g history-limit 100000

# 分屏时保持当前目录
bind '"' split-window -v -c "#{pane_current_path}"
bind '%' split-window -h -c "#{pane_current_path}"

# 快速重排窗口（Vim 键位）：prefix + H/L 左右移动，prefix + K 指定目标序号
bind -r H swap-window -t -1
bind -r L swap-window -t +1
bind K command-prompt -p "移动当前窗口到编号" "move-window -r -t '%%'"

# tmux-jump: <prefix> + j 搜索窗口名跳转（插件已在上方声明）


##### 默认 Shell（根据系统） #####

if-shell "[ $(uname) = 'Linux' ]" \
    'set-option -g default-shell /usr/bin/zsh' \
    'set-option -g default-shell /bin/zsh'


##### 自定义 window list 格式（延迟加载） #####

# 如无需客户端重连时重新加载 window 格式，可移除此 hook
# set-hook -g client-attached "run-shell 'tmux source-file ~/GithubRepos/dotfiles/tmux/window-format.conf'"


##### TPM 初始化（必须在文件末尾） #####

run '~/.tmux/plugins/tpm/tpm'
